# NOTE: This is a Java application which does not support FIPS mode, or provide
# a mechanism to replace / guarantee that only FIPS approved crypto libraries
# are used (Java applications can bundle their own crypto libraries). Therefore,
# THIS IS NOT A FIPS COMPLIANT JAVA PACKAGE. It does however include the bcfips
# JDK as a runtime dependency, only because customer(s) have requested this.
package:
  name: docker-selenium-jre-bcfips
  # Officially they distribute the version with the following format: 4.16.1-20231219
  # But the '-' is not a valid character according to APK versioning spec; and resulting
  # 'package format error' when trying to install the package. The workaround is
  # to replace '-' with '.', then mangling the version to replace back.
  version: 4.17.0.20240123
  epoch: 0
  description: Provides a simple way to run Selenium Grid with Chrome, Firefox, and Edge using Docker, making it easier to perform browser automation
  copyright:
    - license: Apache-2.0
  target-architecture:
    # TODO: Enable aarch64
    # Requires aarch64 variant of Chromedriver
    - x86_64
  dependencies:
    runtime:
      - openjdk-11-bcfips
      - libfontconfig1
      - mcookie
      - glibc-locale-en
      - freetype
      - font-misc-cyrillic
      - font-liberation
      - font-ipa
      - font-wqy-zenhei
      - font-ubuntu
      - font-noto-emoji
      - ttf-dejavu
      - novnc
      - fluxbox
      - pulseaudio
      - x11vnc
      - xauth
      - xmessage
      - Xvfb
      - xvfb-run
      - websockify
      - tzdata
      - sudo-rs
      - libnss-tools
      - supervisor
      - glib
      - libnss
      - libxcb
      - libgcc
      - bash
      - xvfb-run
      - coreutils
      - xauth
      - mcookie
      - xmessage
      - xkeyboard-config
      - xkbcomp
      - fontconfig
      - chromium

environment:
  contents:
    packages:
      - bash
      - build-base
      - busybox
      - ca-certificates-bundle
      - git
      - openssl
      - acl
      - bzip2
      - yq
      - gnupg
      - curl
      - openjdk-11
      - openjdk-11-default-jvm
      - openjdk-11-jre
      - x11vnc
  environment:
    JAVA_HOME: /usr/lib/jvm/java-11-openjdk
    SELENIUM_SERVER_VERSION: 4.16.0
    OPENTELEMETRY_VERSION: 1.28.0
    GRPC_VERSION: 1.57.1
    CHROMIUM_VERSION: 121.0.6167.89
    TC: UTC
    SEL_USER: seluser
    SEL_PASSWD: secret

# Transform melange version to replace last dot "." with "-".
var-transforms:
  - from: ${{package.version}}
    match: ^(.+)\.(\d+)$
    replace: $1-$2
    to: mangled-package-version

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/SeleniumHQ/docker-selenium
      tag: ${{vars.mangled-package-version}}
      expected-commit: 48759d2015ac00be5ad41caabdec365bb04861f3

  - uses: patch
    with:
      patches: 0001-fix-paths.patch

  - runs: |
      mkdir -p ${{targets.destdir}}/usr/bin
      mkdir -p ${{targets.destdir}}/etc/supervisor/conf.d
      mkdir -p ${{targets.destdir}}/var/tmp

  # https://github.com/SeleniumHQ/docker-selenium/blob/trunk/Base/Dockerfile
  - working-directory: Base
    pipeline:
      - runs: |
          mkdir -p ${{targets.destdir}}/opt/bin
          install -Dm755 check-grid.sh ${{targets.destdir}}/opt/bin/
          install -Dm755 entry_point.sh ${{targets.destdir}}/opt/bin/
          install -Dm755f supervisord.conf ${{targets.destdir}}/etc
          mkdir -p ${{targets.destdir}}/var/run/supervisor
      # TODO: Package this separately
      # Low priority, contains 0 CVEs at the moment
      - runs: |
          mkdir -p ${{targets.destdir}}/opt/selenium
          curl -sSLf https://github.com/SeleniumHQ/selenium/releases/download/selenium-${SELENIUM_SERVER_VERSION}/selenium-server-${SELENIUM_SERVER_VERSION}.jar -o ${{targets.destdir}}/opt/selenium/selenium-server.jar
          echo "${SEL_PASSWD}" > ${{targets.destdir}}/opt/selenium/initialPasswd
      # TODO: Implement malware scan for jars retrieved by coursier
      - runs: |
          mkdir -p ${{targets.destdir}}/external_jars
          curl -sSLfO https://github.com/coursier/launchers/raw/master/coursier
          chmod +x coursier
          ./coursier fetch --classpath --cache ${{targets.destdir}}/external_jars \
            io.opentelemetry:opentelemetry-exporter-otlp:${OPENTELEMETRY_VERSION} \
            io.opentelemetry:opentelemetry-exporter-jaeger:${OPENTELEMETRY_VERSION} \
            io.grpc:grpc-netty:${GRPC_VERSION} > ${{targets.destdir}}/external_jars/.classpath.txt

  # https://github.com/SeleniumHQ/docker-selenium/blob/trunk/NodeBase/Dockerfile
  - working-directory: NodeBase
    pipeline:
      - runs: |
          install -Dm755 start-selenium-node.sh ${{targets.destdir}}/opt/bin/
          install -Dm755 start-xvfb.sh ${{targets.destdir}}/opt/bin/
          install -Dm755 selenium.conf ${{targets.destdir}}/etc/supervisor/conf.d/
          install -Dm755 start-vnc.sh ${{targets.destdir}}/opt/bin/
          install -Dm755 start-novnc.sh ${{targets.destdir}}/opt/bin/
          install -Dm755 selenium_grid_logo.png ${{targets.destdir}}/usr/share/images/fluxbox/ubuntu-light.png
          install -Dm755 generate_config ${{targets.destdir}}/opt/bin/generate_config
      - runs: |
          mkdir -p ${{targets.destdir}}/home/$SEL_USER/.fluxbox
          mkdir -p ${{targets.destdir}}/tmp/.X11-unix
          mkdir -p ${{targets.destdir}}/home/$SEL_USER/.vnc
          x11vnc -storepasswd $(cat ${{targets.destdir}}/opt/selenium/initialPasswd) ${{targets.destdir}}/home/$SEL_USER/.vnc/passwd

  # https://github.com/SeleniumHQ/docker-selenium/blob/trunk/NodeChrome/Dockerfile
  - working-directory: NodeChrome
    pipeline:
      - runs: install -Dm755 wrap_chrome_binary ${{targets.destdir}}/opt/bin/wrap_chrome_binary
      - runs: |
          export CHROMEDRIVER_VERSION=$(curl -s https://chromedriver.storage.googleapis.com/LATEST_RELEASE)
          curl -sSLfo chromedriver.zip https://chromedriver.storage.googleapis.com/${CHROMEDRIVER_VERSION}/chromedriver_linux64.zip
          unzip chromedriver.zip

          mkdir -p ${{targets.destdir}}/opt/selenium/chromedriver-linux64/
          install -Dm755 chromedriver ${{targets.destdir}}/usr/bin/
          ln -sf ${{targets.destdir}}/usr/bin/chromedriver ${{targets.destdir}}/opt/selenium/chromedriver-$CHROMEDRIVER_VERSION
      - runs: |
          echo "chrome" > ${{targets.destdir}}/opt/selenium/browser_name
          echo $CHROMIUM_VERSION > ${{targets.destdir}}/opt/selenium/browser_version
          echo "\"goog:chromeOptions\": {\"binary\": \"/usr/bin/chromium\"}" > ${{targets.destdir}}/opt/selenium/browser_binary_location

  # https://github.com/SeleniumHQ/docker-selenium/blob/trunk/Standalone/Dockerfile
  - working-directory: Standalone
    pipeline:
      - runs: |
          install -Dm755 start-selenium-standalone.sh ${{targets.destdir}}/opt/bin/start-selenium-standalone.sh
          install -Dm755 selenium.conf ${{targets.destdir}}/etc/supervisor/conf.d/
          install -Dm755 generate_config ${{targets.destdir}}/opt/bin/generate_config

  - uses: strip

subpackages:
  - name: docker-selenium-supervisor-config
    description: Docker Selenium supervisor configuration
    dependencies:
      runtime:
        - docker-selenium
      replaces:
        - supervisor-config
      provides:
        - supervisor-config
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/etc
          mv ${{targets.destdir}}/etc/supervisord.conf ${{targets.subpkgdir}}/etc
          mv ${{targets.destdir}}/etc/supervisor ${{targets.subpkgdir}}/etc

update:
  enabled: false # Manual update is required. Please refer to the on top of the file for the description about versioning workaround.
