name: Withdraw enterprise packages

on:
  workflow_dispatch:
    inputs:
      dry-run:
        type: boolean
        description: Do not actually remove package
        default: false

env:
  PROJECT: prod-images-c6e5
  FQ_SERVICE_ACCOUNT: prod-images-ci@prod-images-c6e5.iam.gserviceaccount.com

jobs:
  withdraw:
    name: Withdraw packages
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      packages: write
      contents: read

    strategy:
      matrix:
        BUCKET:
          - chainguard-enterprise-registry-destination/os/
          - chainguard-enterprise-registry-destination/os/sub-os-openssl1/

    steps:
      - uses: actions/checkout@v3

      - name: 'Authenticate to Google Cloud'
        id: auth
        uses: google-github-actions/auth@v0
        with:
          workload_identity_provider: "projects/618116202522/locations/global/workloadIdentityPools/prod-shared-e350/providers/prod-shared-gha"
          service_account: ${{ env.FQ_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@d51b5346f85640ec2aa2fa057354d2b82c2fcbce # v1.0.1
        with:
          project_id: ${{ env.PROJECT }}

      - name: 'Delete withdrawn packages'
        run: |
          for arch in x86_64 aarch64; do
            for pkg in $(grep -v '\#' withdrawn-packages.txt); do
              echo "=> $pkg"
              if [[ "${{ matrix.dryrun }}" != "" ]]; then
                echo "DRY RUN: gsutil -m rm -f gs://${{ matrix.BUCKET }}/os/$arch/$pkg"
              else
                gsutil -m rm -f gs://${{ matrix.BUCKET }}/os/$arch/$pkg || true
              fi
            done
          done

      - uses: 'google-github-actions/get-secretmanager-secrets@v1'
        id: secrets
        with:
          secrets: |-
            token:${{ env.PROJECT }}/projects/182740772562/secrets/melange-signing-key-enterprise

      - run: echo ${{ steps.secrets.outputs.token }} > ./chainguard-enterprise.rsa

      - name: 'Generate APKIndex x86'
        if: ${{ matrix.dryrun }} != ""
        uses: docker://ghcr.io/wolfi-dev/wolfictl:latest@sha256:f73762226f1163ae7341a93cd1432d5cffa921891e9f92de9e2e3cf7a954776f
        with:
          entrypoint: wolfictl
          args: generate-index --bucket gs://${{ matrix.BUCKET }} --publish --signing-key ./chainguard-enterprise.rsa --arch x86_64

      - name: 'Generate APKIndex arm64'
        if: ${{ matrix.dryrun }} != ""
        uses: docker://ghcr.io/wolfi-dev/wolfictl:latest@sha256:f73762226f1163ae7341a93cd1432d5cffa921891e9f92de9e2e3cf7a954776f
        with:
          entrypoint: wolfictl
          args: generate-index --bucket gs://${{ matrix.BUCKET }} --publish --signing-key ./chainguard-enterprise.rsa --arch aarch64

  postrun:
    name: Post Withdraw Enterprise Package
    runs-on: ubuntu-latest
    needs:
      - withdraw
    if: failure()
    steps:
      - uses: slackapi/slack-github-action@007b2c3c751a190b6f0f040e47ed024deaa72844 # v1.23.0
        id: slack
        with:
          payload: '{"text": "[withdraw-package-enterprise] failure: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
