name: Withdraw enterprise packages

on:
  workflow_dispatch:
    inputs:
      dry-run:
        type: boolean
        description: Do not actually remove package
        default: false

# Don't withdraw during builds, to prevent out of sync signatures.
concurrency: build

env:
  PROJECT: prod-images-c6e5
  FQ_SERVICE_ACCOUNT: prod-images-ci@prod-images-c6e5.iam.gserviceaccount.com

jobs:
  withdraw:
    name: Withdraw packages
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      packages: write
      contents: read

    strategy:
      matrix:
        BUCKET:
          - chainguard-enterprise-registry-destination/os
          - chainguard-enterprise-registry-destination/os/sub-os-openssl1

    steps:
      - uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4.1.0

      - uses: chainguard-dev/actions/setup-melange@main

      - name: 'Authenticate to Google Cloud'
        id: auth
        uses: google-github-actions/auth@35b0e87d162680511bf346c299f71c9c5c379033 # v1.1.1
        with:
          workload_identity_provider: "projects/618116202522/locations/global/workloadIdentityPools/prod-shared-e350/providers/prod-shared-gha"
          service_account: ${{ env.FQ_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@e30db14379863a8c79331b04a9969f4c1e225e0b # v1.1.1
        with:
          project_id: ${{ env.PROJECT }}

      - uses: 'google-github-actions/get-secretmanager-secrets@v1'
        id: secrets
        with:
          secrets: |-
            token:${{ env.PROJECT }}/melange-signing-key-enterprise
      - run: echo "${{ steps.secrets.outputs.token }}" > ./chainguard-enterprise.rsa
      - run: |
          sudo mkdir -p /etc/apk/keys
          sudo cp ./chainguard-enterprise.rsa.pub /etc/apk/keys/chainguard-enterprise.rsa.pub

      - name: 'Delete withdrawn packages'
        run: |
          for arch in x86_64 aarch64; do
            for pkg in $(grep -v '\#' withdrawn-packages.txt); do
              echo "=> $pkg"
              if [[ "${{ matrix.dryrun }}" != "" ]]; then
                echo "DRY RUN: gsutil -m rm -f gs://${{ matrix.BUCKET }}/$arch/$pkg"
              else
                gsutil -m rm -f gs://${{ matrix.BUCKET }}/$arch/$pkg || true
              fi
            done
          done

      - name: 'Sync public package repository'
        run: |
          mkdir "${{ github.workspace }}/packages"
          gsutil -m rsync -r gs://${{ matrix.BUCKET }}/ "${{ github.workspace }}/packages/"
          find "${{ github.workspace }}/packages" -print -exec touch \{} \;

      - name: 'Reconcile Enterprise index'
        run: |
          for arch in x86_64 aarch64; do
            pushd "${{ github.workspace }}/packages/"$arch
              melange index -o APKINDEX.tar.gz -a $arch *.apk
              melange sign-index --signing-key="${{ github.workspace }}/chainguard-enterprise.rsa" APKINDEX.tar.gz
              gsutil -h "Cache-Control:no-store" cp -a "public-read" "${{ github.workspace }}/packages/${arch}/APKINDEX.tar.gz" gs://${{ matrix.BUCKET }}/${arch}/APKINDEX.tar.gz
            popd
          done

  postrun:
    name: Post Withdraw Enterprise Package
    runs-on: ubuntu-latest
    needs: [withdraw]
    if: failure()
    steps:
      - uses: rtCamp/action-slack-notify@v2.2.1
        env:
          SLACK_ICON: http://github.com/chainguard-dev.png?size=48
          SLACK_USERNAME: guardian
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: chainguard-images-alerts
          SLACK_COLOR: '#8E1600'
          MSG_MINIMAL: 'true'
          SLACK_TITLE: '[withdraw-package-enterprise] failure: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          SLACK_MESSAGE: |
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
