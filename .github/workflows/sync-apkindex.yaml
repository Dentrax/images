name: Sync APKIndex

on:
  workflow_dispatch:
  # TODO: enable cron?

env:
  PROJECT: prod-images-c6e5
  CLUSTER_NAME: tmp-cluster-enterprise-${{github.run_id}}
  CLUSTER_ZONE: us-central1-b
  SERVICE_ACCOUNT: prod-images-ci
  FQ_SERVICE_ACCOUNT: prod-images-ci@prod-images-c6e5.iam.gserviceaccount.com

jobs:
  sync-apk-index:
    name: Sync APKIndex
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    strategy:
      matrix:
        BUCKET:
          - chainguard-enterprise-registry-destination/os/
          - chainguard-enterprise-registry-destination/os/sub-os-openssl1/

    steps:
      - uses: google-github-actions/auth@ef5d53e30bbcd8d0836f4288f5e50ff3e086997d # v1.0.0
        with:
          workload_identity_provider: "projects/618116202522/locations/global/workloadIdentityPools/prod-shared-e350/providers/prod-shared-gha"
          service_account: ${{ env.FQ_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@d51b5346f85640ec2aa2fa057354d2b82c2fcbce # v1.0.1
        with:
          project_id: ${{ env.PROJECT }}

      - uses: 'google-github-actions/get-secretmanager-secrets@v1'
        id: secrets
        with:
          secrets: |-
            token:${{ env.PROJECT }}/projects/182740772562/secrets/melange-signing-key-enterprise

      - run: echo ${{ steps.secrets.outputs.token }} > ./chainguard-enterprise.rsa

      - name: 'Generate APKIndex x86'
        uses: docker://ghcr.io/wolfi-dev/wolfictl:latest@sha256:5cbb46d9b3a8dd18409ad47ae7682ca761a84ac7dcec8d22f16acc3c12e37e7c
        with:
          entrypoint: wolfictl
          args: generate-index --bucket gs://${{ matrix.BUCKET }} --publish --signing-key ./chainguard-enterprise.rsa --arch x86_64

      - name: 'Generate APKIndex arm64'
        uses: docker://ghcr.io/wolfi-dev/wolfictl:latest@sha256:5cbb46d9b3a8dd18409ad47ae7682ca761a84ac7dcec8d22f16acc3c12e37e7c
        with:
          entrypoint: wolfictl
          args: generate-index --bucket gs://${{ matrix.BUCKET }} --publish --signing-key ./chainguard-enterprise.rsa --arch aarch64

  postrun:
    name: Post Enterprise Build
    runs-on: ubuntu-latest
    needs:
      - sync-apk-index
    if: failure()
    steps:
      - uses: slackapi/slack-github-action@007b2c3c751a190b6f0f040e47ed024deaa72844 # v1.23.0
        id: slack
        with:
          payload: '{"text": "[apkindex-sync-enterprise] failure: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
