package:
  name: elasticsearch-7
  version: 7.17.14
  epoch: 3
  description:
  copyright:
    - license: SSPL
  dependencies:
    runtime:
      - bash # some helper scripts use bashw
      - elasticsearch-config
      - openjdk-17-jre
      - openjdk-17-default-jvm
    provides:
      - elasticsearch=${{package.full-version}}

environment:
  contents:
    repositories:
      - https://packages.wolfi.dev/os
    keyring:
      - https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
    packages:
      - busybox
      - ca-certificates-bundle
      - curl
      - openjdk-17
      - openjdk-17-default-jvm

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/elastic/elasticsearch
      tag: v${{package.version}}
      expected-commit: 774e3bfa4d52e2834e4d9d8d669d77e4e5c1017f

  - uses: patch
    with:
      patches: CVE-2020-13956.patch

  - uses: patch
    with:
      patches: CVE-2021-40690.patch

  - uses: patch
    with:
      patches: CVE-2023-4586.patch

  - uses: patch
    with:
      patches: CVE-2023-1370.patch

  - uses: patch
    with:
      patches: guava.patch

  - uses: patch
    with:
      patches: bouncycastle.patch

  - uses: patch
    with:
      patches: CVE-2023-44483.patch

  - runs: |
      export LANG=en_US.UTF-8

      touch license.key

      ./gradlew -Dbuild.snapshot=false -Dlicense.key=license.key localDistro

      mkdir -p ${{targets.destdir}}/usr/share/elasticsearch/logs

      # https://github.com/elastic/elasticsearch/blob/d87b93f3174e82a86f4fad0ea8b85ac7b454f96d/plugins/examples/settings.gradle#L59-L76
      if [ "${{build.arch}}" = "aarch64" ]; then
        BUILD_DIR="linux-aarch64-tar"
      else
        BUILD_DIR="linux-tar"
      fi

      find distribution/archives
      install -dm777 ${{targets.destdir}}/usr/share/elasticsearch/
      mv distribution/archives/${BUILD_DIR}/build/install/elasticsearch-${{package.version}}/bin ${{targets.destdir}}/usr/share/elasticsearch
      mv distribution/archives/${BUILD_DIR}/build/install/elasticsearch-${{package.version}}/lib ${{targets.destdir}}/usr/share/elasticsearch
      mv distribution/archives/${BUILD_DIR}/build/install/elasticsearch-${{package.version}}/config ${{targets.destdir}}/usr/share/elasticsearch
      mv distribution/archives/${BUILD_DIR}/build/install/elasticsearch-${{package.version}}/modules ${{targets.destdir}}/usr/share/elasticsearch
      mv distribution/archives/${BUILD_DIR}/build/install/elasticsearch-${{package.version}}/plugins ${{targets.destdir}}/usr/share/elasticsearch

      # Grab the docker entrypoint from the source tree
      mv ./distribution/docker/src/docker/bin/docker-entrypoint.sh  ${{targets.destdir}}/usr/share/elasticsearch/bin

      # Set permissions to read/write the config dir
      chmod -R 775 ${{targets.destdir}}/usr/share/elasticsearch/
      mkdir -p ${{targets.destdir}}/usr/bin
      for i in ${{targets.destdir}}/usr/share/elasticsearch/bin/*; do
        name=$(basename $i)
        ln -sf /usr/share/elasticsearch/bin/$name ${{targets.destdir}}/usr/bin/$name
      done

      # We get this from elasticsearch-config
      mv ${{targets.destdir}}/usr/share/elasticsearch/config/elasticsearch.yml ${{targets.destdir}}/usr/share/elasticsearch/config/elasticsearch.example.yml

      # Manually set this to docker: https://github.com/elastic/elasticsearch/blob/58f45eabb116b245a0e607dbd900173ecfd46a0f/distribution/docker/src/docker/Dockerfile#L105
      sed -i -e 's/ES_DISTRIBUTION_TYPE=tar/ES_DISTRIBUTION_TYPE=docker/'  ${{targets.destdir}}/usr/share/elasticsearch/bin/elasticsearch-env

update:
  enabled: true
  github:
    identifier: elastic/elasticsearch
    strip-prefix: v
    tag-filter: v7.
