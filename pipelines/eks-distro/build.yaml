name: Build Component from eks-distro

needs:
  packages:
    - git
    - busybox
    - go

inputs:
  eks-project:
    description: |
      The name of the project inside the eks-distro repo. (e.g. kubernetes-csi/external-attacher)
    required: true

  eks-package-version:
    description: |
      The package version in eks-distro (e.g. v1-25-eks-23)
    required: true

  deps:
    description: |
      space separated list of go modules to update before building. example: github.com/foo/bar@v1.2.3

pipeline:
  - runs: |
      export BINARY_PLATFORMS=$(go env GOOS)/$(go env GOARCH)
      export RELEASE_BRANCH=$(echo ${{inputs.eks-package-version}} | grep -oE '[0-9]+-[0-9]+')
      export RELEASE_ENVIRONMENT=production

      cd projects/${{inputs.eks-project}}

      # Extract useful variables from the Makefile of the project.
      REPO=$(grep -m 1 REPO Makefile | sed 's/^.*=//g')

      make checkout-repo

      # Install any specified dependencies
      if [ ! "${{inputs.deps}}" == "" ]; then
        cd ${REPO}
        for dep in ${{inputs.deps}}; do
          go get $dep
        done
        go mod tidy
        cd ..
      fi

      make binaries
