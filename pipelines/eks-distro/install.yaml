name: Install Component from eks-distro

needs:
  packages:
    - go

inputs:
  eks-project:
    description: |
      The name of the project inside the eks-distro repo. (e.g. kubernetes-csi/external-attacher)
    required: true

  eks-package-version:
    description: |
      The package version in eks-distro (e.g. v1-25-eks-23)
    required: true

  binary-target:
    description: |
      The binary target to install (e.g. csi-attacher)
    required: true

pipeline:
  - runs: |
      export RELEASE_BRANCH=$(echo ${{inputs.eks-package-version}} | grep -oE '[0-9]+-[0-9]+')
      cd projects/${{inputs.eks-project}}

      # Extract useful variables from the Makefile of the project.
      REPO=$(grep -m 1 REPO Makefile | sed 's/^.*=//g')

      mkdir -p "${{targets.contextdir}}"/usr/bin
      ARCH=$(go env GOARCH)
      OS=$(go env GOOS)
      cp ./_output/${RELEASE_BRANCH}/bin/${REPO}/${OS}-${ARCH}/${{inputs.binary-target}} "${{targets.contextdir}}"/usr/bin/${{inputs.binary-target}}
