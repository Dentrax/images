package:
  name: spark-3.5.0-compat
  version: 3.5.0
  epoch: 4
  description: "Compat package for Spark Bitnami variant"
  copyright:
    - license: "Apache-2.0"
  dependencies:
    runtime:
      - bash
      - busybox
      - python-3.11
      - openjdk-17-jre
      - findutils
      - openjdk-17-jre-base
      - net-tools
      - procps

environment:
  contents:
    packages:
      - bash
      - busybox
      - build-base
      - python-3.11
      - coreutils
      - ca-certificates-bundle
      - findutils
      - gradle
      - openjdk-8
      - openjdk-8-default-jvm
      - spark
      - wolfi-base
      - hadoop-client-modules
  environment:
    JAVA_HOME: /usr/lib/jvm/java-1.8-openjdk
    LANG: en_US.UTF-8

pipeline:
  - uses: fetch
    with:
      uri: https://github.com/bitnami/containers/archive/cc97b14f376dd0a1f483c6e7c13ff6fb405f4b61.tar.gz
      expected-sha256: 31fc12afd155fdb50a07a3734c062edd69e05a8fe54e64da8d6a278535bad55f

  - uses: patch
    with:
      patches: entrypoint.sh.diff run.sh.diff

  - runs: |
      mkdir -p "${{targets.destdir}}"/opt/bitnami
      mkdir -p "${{targets.destdir}}"/opt/bitnami/licenses
      mkdir -p "${{targets.destdir}}"/opt/bitnami/scripts

      patch /usr/lib/spark/3.5.0/bin/load-spark-env.sh load-spark-env.sh.diff # this should be in the spark package itself
      patch /usr/lib/spark/3.5.0/sbin/spark-daemon.sh spark-daemon.sh.diff   # this should be in the spark package itself

      mv /usr/lib/spark/3.5.0 "${{targets.destdir}}"/opt/bitnami/spark
      mv /usr/share/java/hadoop-client-*.jar "${{targets.destdir}}"/opt/bitnami/spark/jars

      mkdir -p "${{targets.destdir}}"/opt/bitnami/spark/logs
      mkdir -p "${{targets.destdir}}"/opt/bitnami/spark/tmp

      cd bitnami/spark/3.5/debian-11
      cp -R ./prebuildfs/opt/bitnami/* "${{targets.destdir}}"/opt/bitnami/
      cp -R ./rootfs/opt/bitnami/* "${{targets.destdir}}"/opt/bitnami/

      cd -
      gradle getDeps
      find build -iname "*.jar" |xargs cp -t "${{targets.destdir}}"/opt/bitnami/spark/jars/
      for jar in $(cat jars.txt); do
        echo "Removing outdated $jar"
        rm "${{targets.destdir}}/opt/bitnami/spark/jars/$jar"
      done
      chmod g+rwX "${{targets.destdir}}"/opt/bitnami
      chown -R 1001:0 "${{targets.destdir}}"/opt/bitnami

      # sed all the scripts to use absolute path in the build environment
      find "${{targets.destdir}}/opt/bitnami" -iname "*.sh" -exec sed 's#/opt/bitnami#${{targets.destdir}}/opt/bitnami#g' -i {} \;

      # this script does some magic with env vars, templates, etc. etc.
      # it is easier to run it than figure out everything that it touches
      ${{targets.destdir}}/opt/bitnami/scripts/spark/postunpack.sh

      # un-sed everything back to absolute /opt/bitnami prefix
      find ${{targets.destdir}}/opt/bitnami -type f -exec sed 's#${{targets.destdir}}##g' -i {} \;

update:
  enabled: false
