# source is gitlab so we can't use github updates to get expected commit
# let's still auto create the PR, it will fail as expected commit will be wrong
# however it will be easy to fix
#nolint:git-checkout-must-use-github-updates
package:
  name: smarter-device-manager-fips
  version: 1.20.11
  epoch: 1
  description: Device manager container that enables access to device drivers on containers for k8s
  copyright:
    - license: Apache-2.0

environment:
  contents:
    keyring:
      - https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
    repositories:
      - https://packages.wolfi.dev/os
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - go-fips

pipeline:
  - uses: git-checkout
    with:
      repository: https://gitlab.com/arm-research/smarter/smarter-device-manager
      expected-commit: 07f4b88b53c4c21c576a11347a6cbba47bce3103
      tag: v${{package.version}}

  - working-directory: /arm.com/smarter-device-management

  - runs: |
      # This matches the upstream image build, which doesn't commit the go.mod
      # but rather init's it at build time for some ungodly reason:
      # https://gitlab.com/arm-research/smarter/smarter-device-manager/-/blob/fe5dca8f1ced22687da3e47c71749db514b94fba/Dockerfile#L12
      go mod init arm.com/smarter-device-management
      go mod tidy
      go mod vendor

      CGO_ENABLED=0 go build -ldflags='-w -extldflags="-static"' .

      mkdir -p "${{targets.destdir}}"/usr/bin
      mkdir -p ${{targets.destdir}}/etc/smarter-device-manager
      cp conf.yaml ${{targets.destdir}}/etc/smarter-device-manager/
      cp smarter-device-management ${{targets.destdir}}/usr/bin/

  - uses: strip

update:
  enabled: true
  release-monitor:
    identifier: 369506
