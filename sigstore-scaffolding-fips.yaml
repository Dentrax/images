package:
  name: sigstore-scaffolding-fips
  version: 0.6.8
  epoch: 2
  description: Software Supply Chain Transparency Log
  target-architecture:
    - all
  copyright:
    - license: Apache-2.0
      paths:
        - "*"
  checks:
    disabled:
      - empty

environment:
  contents:
    repositories:
      - https://packages.wolfi.dev/os
    keyring:
      - https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
    packages:
      - ca-certificates-bundle
      - busybox
      - git
      - go-fips

data:
  - name: components
    items:
      ctlog-createctconfig: ./cmd/ctlog/createctconfig
      ctlog-managectroots: ./cmd/ctlog/managectroots
      ctlog-verifyfulcio: ./cmd/ctlog/verifyfulcio
      fulcio-createcerts: ./cmd/fulcio/createcerts
      getoidctoken: ./cmd/getoidctoken
      rekor-createsecret: ./cmd/rekor/createsecret
      trillian-createdb: ./cmd/trillian/createdb
      trillian-createtree: ./cmd/trillian/createtree
      trillian-updatetree: ./cmd/trillian/updatetree
      tsa-createcertchain: ./cmd/tsa/createcertchain
      tuf-createsecret: ./cmd/tuf/createsecret
      tuf-server: ./cmd/tuf/server

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/sigstore/scaffolding
      tag: v${{package.version}}
      expected-commit: 76f6bf19030792b4fa88fcffd188975ffe84514e

subpackages:
  - range: components
    name: "${{package.name}}-${{range.key}}"
    pipeline:
      - uses: go/build
        with:
          modroot: .
          subpackage: "true"
          packages: ${{range.value}}
          output: ${{range.key}}
          ldflags: -w
          go-package: go-fips
      - uses: strip

  - name: "${{package.name}}-cloudsqlproxy"
    pipeline:
      - uses: go/build
        with:
          modroot: .
          subpackage: "true"
          packages: ./cmd/cloudsqlproxy
          output: cloudsqlproxy
          ldflags: -w
          go-package: go-fips
      - uses: strip
    dependencies:
      runtime:
        - cloud-sql-proxy-fips
        - cloud-sql-proxy-fips-compat

update:
  enabled: true
  github:
    identifier: sigstore/scaffolding
    strip-prefix: v
