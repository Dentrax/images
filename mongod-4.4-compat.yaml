# This package should be a subpackage off the main mongod-4.4, but mongod takes 40-45 minutes to rebuild each time.
# Additionally, it has a different license from MongoDB, so keeping it in its own package is easier for now.
package:
  name: mongod-4.4-compat
  version: 4.4
  epoch: 0
  description: "Compat package for MongoDB database daemon"
  copyright:
    - license: "Apache-2.0"
  dependencies:
    runtime:
      - gosu
      - mongo
      - mongo-tools
      - mongod-4.4
      - mongosh
      - render-template
      - wait-for-port
      - yq

environment:
  contents:
    repositories:
      - https://packages.wolfi.dev/os
    keyring:
      - https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
    packages:
      - bash
      - build-base
      - busybox
      - ca-certificates-bundle
      - gosu
      - mongo
      - mongo-tools
      - mongod-4.4
      - mongosh
      - render-template
      - wait-for-port
      - wolfi-base
      - yq

pipeline:
  - uses: fetch
    with:
      uri: https://github.com/bitnami/containers/archive/6f7d2e5d560d689b07ed480777bd8eaa867bc75c.tar.gz
      expected-sha256: 1016d4031f9e767423f71861109a81fbfc054d56df4fc294cfa02f31a233d652

  # The bitnami/compat pipeline won't work here since bitnami/mongodb/4.4/debian-10 was removed from main
  - runs: |
      mkdir -p "${{targets.destdir}}"/opt/bitnami
      mkdir -p "${{targets.destdir}}"/opt/bitnami/licenses
      mkdir -p "${{targets.destdir}}"/opt/bitnami/scripts
      mkdir -p "${{targets.destdir}}"/opt/bitnami/etc
      mkdir -p "${{targets.destdir}}"/opt/bitnami/common/bin
      mkdir -p "${{targets.destdir}}"/opt/bitnami/mongodb/bin
      mkdir -p "${{targets.destdir}}"/opt/bitnami/mongodb/logs
      mkdir -p "${{targets.destdir}}"/opt/bitnami/mongodb/tmp
      mkdir -p "${{targets.destdir}}"/bitnami/mongodb/conf
      mkdir -p "${{targets.destdir}}"/bitnami/mongodb/data/db

      cd bitnami/mongodb/4.4/debian-10

      # sed all the scripts to use absolute path in the build environment
      find . -iname "*.sh" -exec sed 's#/opt/bitnami#${{targets.destdir}}/opt/bitnami#g' -i {} \;

      cp -R ./prebuildfs/opt/bitnami/* ${{targets.destdir}}/opt/bitnami/
      cp -R ./rootfs/opt/bitnami/* ${{targets.destdir}}/opt/bitnami/
      chmod g+rwX "${{targets.destdir}}"/opt/bitnami

      # this script does some magic with env vars, templates, etc. etc.
      # it is easier to run it than figure out everything that it touches
      ${{targets.destdir}}/opt/bitnami/scripts/mongodb/postunpack.sh

      # un-sed everything back to absolute /opt/bitnami prefix
      find ${{targets.destdir}}/opt/bitnami -type f -exec sed 's#${{targets.destdir}}##g' -i {} \;

  - runs: |
      ln -sf /usr/bin/gosu "${{targets.destdir}}"/opt/bitnami/common/bin/gosu
      ln -sf /usr/bin/render-template "${{targets.destdir}}"/opt/bitnami/common/bin/render-template
      ln -sf /usr/bin/wait-for-port "${{targets.destdir}}"/opt/bitnami/common/bin/wait-for-port
      ln -sf /usr/bin/yq "${{targets.destdir}}"/opt/bitnami/common/bin/yq

  - runs: |
      ln -sf /usr/bin/mongo* "${{targets.destdir}}"/opt/bitnami/mongodb/bin/

  - runs: |
      # touch/mkdir these empty files and directories to quiet various startup messages per upstream
      touch "${{targets.destdir}}"/.dbshell
      touch "${{targets.destdir}}"/.mongorc.js
      touch "${{targets.destdir}}"/.mongoshrc.js
      mkdir "${{targets.destdir}}"/.mongodb
      mkdir "${{targets.destdir}}"/docker-entrypoint-initdb.d

update:
  # bitnami removed 4.2 and 4.4 from the repo, so there are no updates to be had
  enabled: false
