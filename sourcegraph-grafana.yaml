package:
    name: sourcegraph-grafana
    version: 5.2.7
    epoch: 0
    description: Sourcegraph packaged Grafana
    copyright:
        - license: Apache-2.0
    dependencies:
        runtime:
            - grafana-7
            - grafana-7-dashboards
            - krb5
            - apk-tools
            - libssl3
            - openssl
            - ncurses
            - ncurses-terminfo
            - libtirpc
environment:
    contents:
        packages:
            - ca-certificates-bundle
            - busybox
            - go
pipeline:
    - uses: git-checkout
      with:
        repository: https://github.com/sourcegraph/sourcegraph
        destination: sourcegraph
        tag: v${{package.version}}
        expected-commit: e70cef81d159907f5d282c570812f8e04e67f671
    - runs: |
        cd sourcegraph/monitoring
        go build \
          -trimpath \
          -o monitoring-generator .

        mkdir -p generated

        GRAFANA_DIR=generated PROMETHEUS_DIR='' DOCS_DIR='' NO_PRUNE=true ./monitoring-generator

        mkdir -p ${{targets.destdir}}/usr/share/grafana/public/dashboards
        mv generated/home.json ${{targets.destdir}}/usr/share/grafana/public/dashboards/

        mkdir -p ${{targets.destdir}}/sg_config_grafana/provisioning/dashboards/sourcegraph
        mv generated/* ${{targets.destdir}}/sg_config_grafana/provisioning/dashboards/sourcegraph/
    - runs: |
        mkdir -p ${{targets.destdir}}/opt/grafana
        chmod +x entry.sh
        mv entry.sh ${{targets.destdir}}/opt/grafana/

        cp -R config/* ${{targets.destdir}}/sg_config_grafana/
update:
    enabled: true
    github:
        identifier: sourcegraph/sourcegraph
        strip-prefix: v
        tag-filter: v
