package:
  name: elasticsearch
  version: "8.10.0"
  epoch: 0
  description:
  copyright:
    - license: SSPL
  dependencies:
    runtime:
      - bash # some helper scripts use bashw

environment:
  contents:
    repositories:
      - https://packages.wolfi.dev/os
    keyring:
      - https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
    packages:
      - busybox
      - ca-certificates-bundle
      - curl
      - openjdk-17
      - openjdk-17-default-jvm

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/elastic/elasticsearch
      tag: v${{package.version}}
      expected-commit: e338da74c79465dfdc204971e600342b0aa87b6b

  - runs: |
      export LANG=en_US.UTF-8

      ./gradlew localDistro

      mkdir -p ${{targets.destdir}}/usr/share/elasticsearch/logs

      find distribution/archives
      install -dm777 ${{targets.destdir}}/usr/share/elasticsearch/
      mv distribution/archives/linux-tar/build/install/elasticsearch-${{package.version}}-SNAPSHOT/bin ${{targets.destdir}}/usr/share/elasticsearch
      mv distribution/archives/linux-tar/build/install/elasticsearch-${{package.version}}-SNAPSHOT/lib ${{targets.destdir}}/usr/share/elasticsearch
      mv distribution/archives/linux-tar/build/install/elasticsearch-${{package.version}}-SNAPSHOT/config ${{targets.destdir}}/usr/share/elasticsearch
      mv distribution/archives/linux-tar/build/install/elasticsearch-${{package.version}}-SNAPSHOT/modules ${{targets.destdir}}/usr/share/elasticsearch
      mv distribution/archives/linux-tar/build/install/elasticsearch-${{package.version}}-SNAPSHOT/plugins ${{targets.destdir}}/usr/share/elasticsearch
      mv distribution/archives/linux-tar/build/install/elasticsearch-${{package.version}}-SNAPSHOT/jdk ${{targets.destdir}}/usr/share/elasticsearch

      # Grab the docker entrypoint from the source tree
      mv ./distribution/docker/src/docker/bin/docker-entrypoint.sh  ${{targets.destdir}}/usr/share/elasticsearch/bin

      # Set permissions to read/write the config dir
      chmod -R 777 ${{targets.destdir}}/usr/share/elasticsearch/

      mkdir -p ${{targets.destdir}}/usr/bin
      for i in ${{targets.destdir}}/usr/share/elasticsearch/bin/*; do
        name=$(basename $i)
        ln -sf /usr/share/elasticsearch/bin/$name ${{targets.destdir}}/usr/bin/$name
      done

      # # Manually set this to docker: https://github.com/elastic/elasticsearch/blob/58f45eabb116b245a0e607dbd900173ecfd46a0f/distribution/docker/src/docker/Dockerfile#L105
      sed -i -e 's/ES_DISTRIBUTION_TYPE=tar/ES_DISTRIBUTION_TYPE=docker/'  ${{targets.destdir}}/usr/share/elasticsearch/bin/elasticsearch-env

update:
  enabled: true
  github:
    identifier: elastic/elasticsearch
    strip-prefix: v
