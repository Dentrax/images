package:
  name: gotenborg
  version: 8.0.3
  epoch: 0
  description: A developer-friendly API for converting numerous document formats into PDF files, and more!
  copyright:
    - license: Apache-2.0
  # since chromium is only built for x86_64
  target-architecture:
    - x86_64
  dependencies:
    runtime:
      - busybox
      - chromium
      # - libreoffice: https://github.com/wolfi-dev/os/pull/11516
      - pdftk
      - qpdf
      - tini
      - python3
      - gnupg
      - font-wqy-zenhei
      - msttcorefonts-installer
      - font-noto-cjk
      - font-noto-emoji
      - font-ipa
      - font-liberation
      - font-linux-libertine

environment:
  contents:
    packages:
      - busybox
      - ca-certificates-bundle
      - go
      - curl

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/gotenberg/gotenberg
      tag: v${{package.version}}
      expected-commit: 3472d42cddcf439226c477c0180fab6d34f86fc3

  # - uses: go/bump
  #   with:
  #     deps: golang.org/x/crypto@v0.17.0

  - runs: |
      mkdir -p ${{targets.destdir}}/usr/bin
      # Original build command referenced from here:
      # https://github.com/gotenberg/gotenberg/blob/main/build/Dockerfile#L27C5-L27C129
      CGO_ENABLED=0 go build -o gotenberg -ldflags "-X 'github.com/gotenberg/gotenberg/v8/cmd.Version=${{package.version}}'" -o /usr/bin/gotenborg cmd/gotenberg/main.go

      # downloads and installs unoconv
      curl -Ls https://raw.githubusercontent.com/gotenberg/unoconverter/v0.0.1/unoconv -o ${{targets.destdir}}/usr/bin/unoconverter &&\
      chmod +x ${{targets.destdir}}/usr/bin/unoconverter

      mkdir -p ${{targets.destdir}}/etc/fonts/conf.d
      cp build/fonts.conf ${{targets.destdir}}/etc/fonts/conf.d/100-gotenberg.conf

  - uses: strip

update:
  enabled: true
  github:
    identifier: gotenberg/gotenberg
    strip-prefix: v
